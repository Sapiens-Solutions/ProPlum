# Содержимое фреймворка

### Таблицы 
| Таблица           | Описание                                                                                                                        | Способ наполнения                                                                                                                                  |
|-------------------|---------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------|
| objects           | Настройки для загрузки объектов                                                                                                 | Вручную                                                                                                                                            |
| load_info         | Информация по заданиям загрузки данных и их статус                                                                              | Функцией f_gen_load_id. Записи могут изменяться функциями f_update_load_info, f_set_load_id_error, f_set_load_id_in_process, f_set_load_id_success |
| logs              | Логи выполнения операций фреймворка при загрузке данных                                                                         | Функцией f_write_log в процессе выполнения функций фреймворка                                                                                      |
| dependencies      | Информация о зависимостях при загрузке объектов                                                                                 | Вручную                                                                                                                                            |
| objects_log       | История изменения настроек объектов                                                                                             | Автоматически при изменении записи в таблице objects                                                                                               |
| locks             | Таблица содержит в себе информацию о текущих блокировках в процессах загрузки данных                                            | Автоматически во время etl-процессов. Записи могут изменяться функциями f_delete_load_lock, f_get_load_locks, f_set_load_lock                      |
| load_constants    | Константы для настройки процесса загрузки данных                                                                                | Автоматически при развертывании фреймворка, далее вручную                                                                                          |
| ext_tables_params | Расширенные параметры строки подключения для внешних таблиц (для метода загрузки gpfdist)                                       | Вручную                                                                                                                                            |
| d_delta_mode      | Справочник значений поля таблицы objects.delta_mode, содержит описание режимов дельты                                           | Автоматически при развертывании фреймворка, далее вручную                                                                                          |
| d_extraction_type | Справочник значений поля таблицы objects.extraction_type, содержит описание режимов экстракции данных из источника              | Автоматически при развертывании фреймворка, далее вручную                                                                                          |
| d_load_group      | Справочник значений поля таблицы objects.load_group, содержит описание групп загрузки в Airflow                                 | Автоматически при развертывании фреймворка, далее вручную                                                                                          |
| d_load_method     | Справочник значений поля таблицы objects.load_method, содержит описание методов загрузки или расчета данных                     | Автоматически при развертывании фреймворка, далее вручную                                                                                          |
| d_load_status     | Справочник значений поля таблицы load_info.load_status, содержит описание статусов загрузки данных для соответствующего load_id | Автоматически при развертывании фреймворка, далее вручную                                                                                          |
| d_load_type       | Справочник значений поля таблицы objects.load_type, содержит описание типов загрузки данных в целевую таблицу                   | Автоматически при развертывании фреймворка, далее вручную                                                                                          |                                                                                                                                                   |
| dq_testcases      | Справочник тест-кейсов, содержит описание сценариев тестирования по качеству данных                                             | Вручную                                                                                                                                            |
| dq_testcases_runs | Результаты запуска тест-кейсов                                                                                                  | Автоматически скриптом Python или заданием Airflow                                                                                                 |


#### objects
| Поле                | Описание                                                                                                                                                                                                                                                                         |
|---------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| object_id           | id объекта. Заполняется инкрементально от последнего заполненного значения в таблице. Повторяющиеся значения не допускаются                                                                                                                                                      |
| object_name         | Имя заполняемого объекта (таблицы). Заполняется с указанием схемы                                                                                                                                                                                                                |
| object_desс         | Осмысленное описание целевого объекта                                                                                                                                                                                                                                            |
| extraction_type     | Способ экстракции данных из таблицы-источника. Принимает значения: DELTA, PARTITION, FULL                                                                                                                                                                                        |
| load_type           | Тип загрузки данных в целевой объект. Принимает значения: FULL, DELTA, DELTA_MERGE, DELTA_UPSERT (DELETE_INSERT), PARTITION, UPDATE_PARTITION                                                                                                                                    |
| merge_key           | Ключ для мерджа дельты. Заполняется для способов загрузки: DELTA_MERGE, DELTA_UPSERT (DELETE_INSERT), DELTA_UPDATE_PARTITION                                                                                                                                                     |
| delta_field         | Поле для выделения дельты из исходной таблицы. Заполнение обязательно для типов загрузки: DELTA, DELTA_MERGE, DELTA_UPSERT (DELETE_INSERT)                                                                                                                                       |
| delta_field_format  | Формат даты для поля delta_field.                                                                                                                                                                                                                                                |
| delta_safety_period | Доверительный интервал для поля delta_field. Период для учитывания данных прошлых периодов при формировании load_start для load_id. Заполнение релевантно для типов загрузки DELTA, DELTA_MERGE, DELTA_UPSERT (DELETE_INSERT)                                                    |
| bdate_field         | Поле для бизнес даты. Обязательно для типа загрузки DELTA_PARTITION                                                                                                                                                                                                              |
| bdate_field_format  | Формат даты для поля bdate_field                                                                                                                                                                                                                                                 |
| bdate_safety_period | Доверительный интервал для bdate_field. Период для учитывания данных прошлых периодов при при формировании load_start для load_id. Заполнение релевантно для типа загрузки DELTA_PARTITION                                                                                       |
| load_method         | Метод загрузки - способ получения данных для целевой таблицы. Заполнение обязательно. Возможные значения: pxf, gpfdist, function, dblink                                                                                                                                         |
| job_name            | Имя задания Airflow, загружающего данный объект                                                                                                                                                                                                                                  |
| responsible_mail    | Список почтовых адресов, ответственных за загрузку объекта                                                                                                                                                                                                                       |
| priority            | Приоритет загрузки объекта. Используется при построении зависимостей                                                                                                                                                                                                             |
| periodicity         | Периодичность запуска расчета для объекта. Информационное поле                                                                                                                                                                                                                   |
| load_interval       | Период формирования и округления extraction_start - extraction_end для load_id. Заполнение обязательно                                                                                                                                                                           |
| activitystart       | Старт времени активности работы загрузки для объекта. Информационное поле                                                                                                                                                                                                        |
| activityend         | Окончание времени активности работы загрузки для объекта. Информационное поле                                                                                                                                                                                                    |
| active              | Флаг активности объекта. Принимает значения: true, false                                                                                                                                                                                                                         |
| load_start_date     | Начальная дата загрузки данных по bdate_field. Заполнение релевантно для типа загрузки DELTA_PARTITION                                                                                                                                                                           |
| delta_start_date    | Начальная дата загрузки дельты по delta_field. Заполнение релевантно для типов загрузки: DELTA, DELTA_MERGE, DELTA_UPSERT (DELETE_INSERT)                                                                                                                                        |
| delta_mode          | Режим дельты при формировании load_id: DELTA (один load_id), FULL (один load_id), ITER (несколько load_id с периодичностью load_interval). Принимает значения: DELTA, FULL, ITER                                                                                                 |
| connect_string      | Строка подключения к источнику. Для pxf - cодержит в себе имя таблицы-источника в исходной базе, профиль pxf-подключения и сервер; для gpfdist - имя файла, порт                                                                                                                 |
| load_function_name  | Функция по расчету данных после загрузки / функция расчета целевой таблицы. Возможно использование переменных: $load_from, $load_to, $delta_from, $delta_to, $load_id, $load_type, $object_id, значения которых определяются для конкретного load_id                             |
| where_clause        | Условие, применяемое при загрузке данных из исходной системы. Если оно указано, то игнорируются условия фреймворка по определению дельты. Возможно использование переменных: $load_from, $load_to, $delta_from, $delta_to, значения которых определяются для конкретного load_id |
| load_group          | Группа загрузок в Airflow, отвечает за то, в каком блоке будет производиться загрузка данных указанной таблицы                                                                                                                                                                   |
| src_date_type       | Тип поля даты в системе-источнике. Учитывается при создании внешней таблицы, когда тип поля-источника - не дата, а поле приемника - дата                                                                                                                                         |
| src_ts_type         | Тип поля метки времени (таймстемпа) в системе-источнике. Учитывается при создании внешней таблицы, когда тип поля-источника - не таймстемп, а поле приемника - таймстемп                                                                                                         |
| column_name_mapping | Мэппинг имен полей таблицы-источника к таблице-приемнику. Используется, когда имя поля в базе-источнике не совпадает с именем поля в базе-приемнике                                                                                                                              |
| transform_mapping   | Преобразование полей таблицы-источника для заполнения поля таблицы-приемника. Используется синтаксис SQL                                                                                                                                                                         |
| delta_field_type    | Тип поля дельты в системе-источнике                                                                                                                                                                                                                                              |
| bdate_field_type    | Тип поля бизнес даты в системе-источнике                                                                                                                                                                                                                                         |


#### load_info
| Поле            | Описание                                                                                              |
|-----------------|-------------------------------------------------------------------------------------------------------|
| load_id         | id загрузки, генерируется автоматически                                                               |
| load_status     | Статус загрузки: 1 - новая, 2 - в процессе, 3 - успешно завершена, -1 - завершена с ошибкой           |
| object_id       | id объекта из objects                                                                                 |
| extraction_type | Способ экстракции данных из таблицы-источника: DELTA, PARTITION, FULL                                 |
| load_type       | Тип загрузки целевой таблицы: DELTA, DELTA_MERGE, DELTA_PARTITION, DELTA_UPSERT, FULL                 |
| extraction_from | Нижняя граница интервала экстракции                                                                   |
| extraction_to   | Верхняя граница интервала экстракции                                                                  |
| load_from       | Нижняя граница интервала загрузки                                                                     |
| load_to         | Верхняя граница интервала загрузки                                                                    |
| load_method     | Метод загрузки - способ попадания данных в стейджинг: pxf, gpfdist, dblink, python                    |
| job_name        | Имя задания Airflow                                                                                   |
| created_dttm    | Метка времени создания load_id                                                                        |
| updated_dttm    | Метка времени изменения load_id                                                                       |
| row_cnt         | Количество записей, измененных в процессе загрузки                                                    |


#### logs
| Поле          | Описание                                                   |
|---------------|------------------------------------------------------------|
| log_id        | id лога, генерируется автоматически                        |
| load_id       | id загрузки, заполняется при загрузке с помощью фреймворка |
| log_timestamp | Метка времени записи лога                                  |
| log_type      | Тип лога: ERROR, INFO, WARN, DEBUG                         |
| log_msg       | Содержимое лога                                            |
| log_location  | Место возникновения сообщения                              |
| is_error      | Метка ошибки - если тип лога - ERROR                       |
| log_user      | Пользователь, записавший лог                               |


#### dependencies
| Поле              | Описание                                                |
|-------------------|---------------------------------------------------------|
| object_id         | id объекта из objects                                   |
| object_id_depend  | id объекта, от которого зависит dependencies.object_id  |


#### load_constants
| Поле           | Описание                                 |
|----------------|------------------------------------------|
| constant_name  | Имя константы                            |
| constant_type  | Тип возвращаемого значения для константы |
| constant_value | Значение константы                       |


#### locks
| Поле           | Описание                                    |
|----------------|---------------------------------------------|
| load_id        | load_id из load_info                        |
| pid            | pid процесса, установившего блокировку      |
| lock_type      | Тип блокировки                              |
| object_name    | Загружаемый объект                          |
| lock_timestamp | Метка времени установки блокировки          |
| lock_user      | Пользователь, установивший блокировку       |


#### objects_log
Содержимое соответствует таблице objects с дополнительными полями: 

| Поле             | Описание                         |
|------------------|----------------------------------|
| change_type      | Тип изменения записи             |
| change_timestamp | Метка времени изменения записи   |
| change_username  | Пользователь, изменивший запись  |


#### ext_tables_params
| Поле              | Описание                                            |
|-------------------|-----------------------------------------------------|
| object_id         | id объекта из objects                               |
| load_method       | Метод загрузки (код)                                |
| connection_string | Строка подключения                                  |
| additional        | Дополнительная информация к строке подключения      |
| active            | Флаг активности записи                              |


#### dq_testcases
| Поле             | Описание                                                                            |
|------------------|-------------------------------------------------------------------------------------|
| testcase_id      | id тест-кейса                                                                       |
| testcase_name    | Краткое наименование тест-кейса                                                     |
| testcase_desc    | Полное описание тест-кейса                                                          |
| object_name      | Наименование объекта, в котором проверяются данные                                  |
| testcase_sql     | Проверочный запрос                                                                  |
| benchmark_sql    | Проверочный эталонный запрос                                                        |
| test_group       | Группа тест-кейсов                                                                  |
| key_fields       | Список полей, которые являются бизнес-ключем в результатах запроса testcase_sql     |
| active           | Объект активен?                                                                     |
| connect_type     | Тип соединения к БД (OracleHook, psycopg2)                                          |
| object_id        | id объекта из таблицы fw.objects                                                    |
| connect_name     | Имя соединения в Airflow (oracle54, oracle57)                                       |


#### dq_testcases_runs
| Поле              | Описание                                                                |
|-------------------|-------------------------------------------------------------------------|
| testrun_id        | id запуска тест-кейса                                                   |
| testcase_id       | id тест-кейса                                                           |
| test_user         | Пользователь, запустивший тест-кейс                                     |
| testrun_start     | Метка времени запуска тест-кейса                                        |
| testrun_end       | Метка времени окончания выполнения тест-кейса                           |
| testcase_sql      | Проверочный запрос                                                      |
| benchmark_sql     | Проверочный эталонный запрос                                            |
| row_count         | Количество несовпадающих строк по результатам выполнения тест-кейса     |
| test_result       | Несовпадающие строки в формате json                                     |


#### d_delta_mode
| Поле              | Описание                                            |
|-------------------|-----------------------------------------------------|
| delta_mode        | Режим дельты (код)                                  |
| desc_short        | Режим дельты (короткое описание)                    |
| desc_middle       | Режим дельты (среднее описание)                     |
| desc_long         | Режим дельты (длинное описание)                     |


#### d_extraction_type
| Поле              | Описание                                            |
|-------------------|-----------------------------------------------------|
| extraction_type   | Режим экстракции (код)                              |
| desc_short        | Режим экстракции (короткое описание)                |
| desc_middle       | Режим экстракции (среднее описание)                 |
| desc_long         | Режим экстракции (длинное описание)                 |


#### d_load_group
| Поле              | Описание                                            |
|-------------------|-----------------------------------------------------|
| load_group        | Группа загрузок (код)                               |
| desc_short        | Группа загрузок (короткое описание)                 |
| desc_middle       | Группа загрузок (среднее описание)                  |
| desc_long         | Группа загрузок (длинное описание)                  |


#### d_load_method
| Поле              | Описание                                            |
|-------------------|-----------------------------------------------------|
| load_method       | Метод загрузки (код)                                |
| desc_short        | Метод загрузки (короткое описание)                  |
| desc_middle       | Метод загрузки (среднее описание)                   |
| desc_long         | Метод загрузки (длинное описание)                   |


#### d_load_status
| Поле              | Описание                                            |
|-------------------|-----------------------------------------------------|
| load_status       | Статус загрузки (код)                               |
| desc_short        | Статус загрузки (короткое описание)                 |
| desc_middle       | Статус загрузки (среднее описание)                  |
| desc_long         | Статус загрузки (длинное описание)                  |


#### d_load_type
| Поле              | Описание                                            |
|-------------------|-----------------------------------------------------|
| load_type         | Тип загрузки (код)                                  |
| desc_short        | Тип загрузки (короткое описание)                    |
| desc_middle       | Тип загрузки (среднее описание)                     |
| desc_long         | Тип загрузки (длинное описание)                     |


### Схема данных
![Схема данных](https://github.com/Mazan-ka/ProPlum/assets/80702083/12dbbe08-70e9-4115-a579-f921f43e1122)


### Функции
| Функция                                                                                          | Описание                                                                                                                                                                                              |
|--------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| f_analyze_table(text)                                                                            | Сбор статистики по указанной в параметре таблице                                                                                                                                                      |
| f_create_date_partitions(text, timestamp)                                                        | Создание в указанной таблице новой партиции за дату, указанную в параметре. Если партиция есть - новая не создается. Обязательно наличие партиции по умолчанию в целевой таблице                      |
| f_create_ext_table<br/>(text, int8, text, text, text, text, text)                                | Создание внешней таблицы                                                                                                                                                                              |
| f_create_tmp_table<br/>(text, text, text, text, bool, bool)                                      | Создание временной таблицы, которая будет использоваться фреймворком в дальнейшем как стейджинговая                                                                                                   |
| f_delete_load_lock(int8, text)                                                                   | Удаление блокировок, установленных фреймворком для ETL-процесса                                                                                                                                       |
| f_execute_function(text, int8)                                                                   | Запуск указанной функции                                                                                                                                                                              |
| f_extract_data(int8)                                                                             | Загрузка данных из внешней таблицы для указанного id загрузки в стейджинговую таблицу                                                                                                                 |
| f_gen_group_load_id<br/>(text,timestamp,timestamp,text,text,interval,timestamp,timestamp)        | Генерация load_id для группы загрузок                                                                                                                                                                 |
| f_gen_load_id<br/>(int8,timestamp,timestamp,text,text,text,interval,timestamp,timestamp)         | Генерация load_id                                                                                                                                                                                     |
| f_get_connection_string(int8)                                                                    | Получение строки подключения к внешней системе                                                                                                                                                        |
| f_get_constant(text)                                                                             | Получение константы из таблицы load_constants по имени константы                                                                                                                                      |
| f_get_delta_table_name(int8)                                                                     | Получение имени дельта-таблицы для указанного id загрузки                                                                                                                                             |
| f_get_distribution_key(text)                                                                     | Определение ключа дистрибуции для таблицы                                                                                                                                                             |
| f_get_enum_partition(text, text, date, date)                                                     | Получение строки для pxf-партиций в случае использования партиций по отдельным значениям                                                                                                              |
| f_get_ext_table_name(int8)                                                                       | Получение имени внешней таблицы для указанного id загрузки                                                                                                                                            |
| f_get_extr_expression(int8, text, text)                                                          | Получение SQL-выражения для экстракции данных из таблицы-источника в таблицу-приемник с учетом правил трансформации                                                                                   |
| f_get_extract_where_cond(int8, text)                                                             | Получение условия where для экстракции данных из таблицы-источника в таблицу-приемник с учетом правил трансформации                                                                                   |
| f_get_load_expression(int8)                                                                      | Получение SQL-выражения для загрузки из внешней таблицы-источника в таблицу-приемник с учетом правил трансформации                                                                                    |
| f_get_load_function(int8)                                                                        | Получение функции загрузки объекта из objects                                                                                                                                                         |
| f_get_load_id(int8, date, date)                                                                  | Получение load_id для объекта за указанные даты. Если дат не указано - возвращается максимальный по дате                                                                                              |
| f_get_load_locks(text)                                                                           | Получение etl-блокировок, присутствующих в базе для указанной таблицы                                                                                                                                 |
| f_get_locks()                                                                                    | Получение всех блокировок, присутствующих в базе                                                                                                                                                      |
| f_get_max_value(text, text, text)                                                                | Получение максимального значения столбца из таблицы. Необходимо для корректировки даты для load_id                                                                                                    |
| f_get_merge_key(int8)                                                                            | Получение ключа для мерджа по id объекта из objects                                                                                                                                                   |
| f_get_min_value(text, text, text)                                                                | Получение минимального значения столбца из таблицы. Необходимо для корректировки даты для load_id                                                                                                     |
| f_get_partition_interval(text, timestamp)                                                        | Получение интервала партиции для таблицы по указанной дате                                                                                                                                            |
| f_get_partition_key(text)                                                                        | Получение имени колонки, по которой построены партиции в указанной таблице                                                                                                                            |
| f_get_pxf_partition(int8)                                                                        | Формирование строки партиционирования для строки подключения pxf на основании интервала загрузки данных                                                                                               |
| f_get_session_param(text)                                                                        | Получение значения для пользовательского параметра сессии                                                                                                                                             |
| f_get_table_attributes(text)                                                                     | Получение атрибутов указанной таблицы - тип хранения, ориентация, сжатие                                                                                                                              |
| f_get_table_schema(text)                                                                         | Получение схемы указанной таблицы                                                                                                                                                                     |
| f_get_where_clause(int8)                                                                         | Получение условия where для загрузки из внешней системы в целевую таблицу для указанного object_id                                                                                                    |
| f_get_where_cond(int8, text)                                                                     | Функция получения полного условия для загрузки из исходной системы для load_id                                                                                                                        |
| f_grant_select(text, text)                                                                       | Выдача полномочий на таблицу по шаблону                                                                                                                                                               |
| f_insert_table(text, text, text, bool)                                                           | Вставка данных из таблицы-источника в таблицу-приемник с условием                                                                                                                                     |
| f_insert_table_sql(text, text, bool)                                                             | Загрузка данных из SQL запроса в таблицу                                                                                                                                                              |
| f_load_data(int8)                                                                                | Загрузка данных в целевую таблицу из исходной системы                                                                                                                                                 |
| f_load_delta_merge(int8)                                                                         | Загрузка данных путем мерджа таблиц с последующей заменой партиции по умолчанию                                                                                                                       |
| f_load_delta_partitions(int8, text, text, bool, text)                                            | Итерационная загрузка методом смены партиций                                                                                                                                                          |
| f_load_delta_update_partitions<br/>(int8, text, text, text)                                      | Обновление данных в целевой таблице из таблицы-источника методом DELTA_UPDATE_PARTITION. Из исходной таблицы итерационно обновляются данные в соответствующих партициях целевой таблицы               |
| f_load_id_exists(int8, timestamp, timestamp)                                                     | Проверка существования load_id по указанному временному периоду                                                                                                                                       |
| f_load_object(int8)                                                                              | Запуск загрузки объекта с помощью функции objects.load_function                                                                                                                                       |
| f_load_simple(int8, text, text, bool)                                                            | Загрузка целевого объекта без преобразования полей с помощью указанного метода из таблицы-источника                                                                                                   |
| f_load_simple_full(int8, text, text)                                                             | Загрузка целевого объекта с помощью полной перегрузки из таблицы-источника с созданием бэкап-таблицы                                                                                                  |
| f_load_simple_upsert(int8, text, text, bool, text)                                               | Загрузка целевого объекта с помощью update-insert из таблицы-источника по merge-ключу                                                                                                                 |
| f_merge_tables(text, text, text, _text, text)                                                    | Производит мердж таблиц с заменой дефолтной партиции у целевой таблицы с указанным ключом мерджа и возможностью указания целевой таблицы. В процессе создается буферная или указанная целевая таблица |
| f_partition_name_by_value(text, timestamp)                                                       | Получение имени партиции по значению даты, входящей в эту партицию                                                                                                                                    |
| f_partition_name_list_by_date<br/>(text, timestamp, timestamp)                                   | Получение списка партиций для интервала дат                                                                                                                                                           |
| f_prepare_load(int8)                                                                             | Создание временных объектов для загрузки данных в целевую таблицу (delta_, ext_)                                                                                                                      |
| f_set_load_id_error(int8)                                                                        | Установка статуса Ошибка для load_id                                                                                                                                                                  |
| f_set_load_id_in_process(int8)                                                                   | Установка статуса В работе для load_id                                                                                                                                                                |
| f_set_load_id_success(int8)                                                                      | Установка статуса Успешно для load_id                                                                                                                                                                 |
| f_set_load_lock(int8, text, text)                                                                | Установка etl-блокировки на таблицу для указанного load_id                                                                                                                                            |
| f_set_session_param(text, text)                                                                  | Установка значения для пользовательского параметра сессии                                                                                                                                             |
| f_stat_activity()                                                                                | Текущие процессы в БД                                                                                                                                                                                 |
| f_switch_def_partition(text, text)                                                               | Замена дефолтной партиции для таблицы                                                                                                                                                                 |
| f_switch_partition(text, text, text)                                                             | Замена указанной партиции для таблицы                                                                                                                                                                 |
| f_switch_partition(text, timestamp, text)                                                        | Замена партиции для указанного значения с указанной датой                                                                                                                                             |
| f_table_exists(text)                                                                             | Проверка существования таблицы в базе                                                                                                                                                                 |
| f_terminate_backend(int4)                                                                        | Завершение процесса в БД по его pid. Выполняется с полномочиями администратора                                                                                                                        |
| f_terminate_lock(text)                                                                           | Удаление etl-блокировки для таблицы                                                                                                                                                                   |
| f_truncate_table(text)                                                                           | Очистка указанной таблицы через truncate                                                                                                                                                              |
| f_unify_name(text)                                                                               | Приведение имени входного параметра в унифицированный формат                                                                                                                                          |
| f_update_load_info(int8, text, text)                                                             | Обновление указанного поля в таблице load_info                                                                                                                                                        |
| f_update_table_sql(text, text, _text, _text)                                                     | Обновление полей в указанной таблице по набору полей из SQL запроса и списка полей для мерджа                                                                                                         |
| f_update_table_sql(text, text, _text, int8)                                                      | Обновление полей в указанной таблице по набору полей из SQL запроса и id загрузки                                                                                                                     |
| f_upsert_table(int8, text, text, bool, bool, text)                                               | Загрузка таблицы методом UPSERT (delete по ключу мерджа, insert новых данных)                                                                                                                         |
| f_wait_locks(text, int4, int4, bool)                                                             | Таймер ожидания сброса блокировки таблицы                                                                                                                                                             |
| f_write_log(text, text, text, int8)                                                              | Запись лога выполнения операции                                                                                                                                                                       |
| f_upsert_table_sql(text, text, int8, bool)                                                       | Загрузка таблицы методом UPSERT (delete по ключу мерджа, insert новых данных) на основании SQL запроса                                                                                                |
| f_delete_table_sql(text, text, _text)                                                            | Удаление данных в целевой таблице из набора данных, полученных из запроса p_sql по ключу, указанному в списке полей                                                                                   |
| f_create_obj_sql<br/>(text, text, text, text, bool, text, bool, bool, text)                      | Создание таблицы, временной таблицы или view на основании SQL запроса                                                                                                                                 |





#### f_gen_load_id (int8, timestamp, timestamp, text, text, text, interval, timestamp, timestamp)
Функция создает load_id - идентификатор загрузки в таблице *load_info* 

*Выходной параметр*: последний созданный load_id, int8

| Параметр функции   | Описание                                                                                                                                                                                                                                              | 
|--------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| p_object_id        | id объекта загрузки из таблицы objects.object_id. **Обязательный параметр**                                                                                                                                                                           |
| p_start_extr       | Дата начала интервала загрузки для load_id - если не указано, то берется из настроек объекта objects.load_start_date                                                                                                                                  |
| p_end_extr         | Дата окончания интервала загрузки для load_id - если не указано, то берется как current_timestamp                                                                                                                                                     |
| p_extraction_type  | Тип экстракции - FULL, DELTA, PARTITION - если не указано, то берется из настроек объекта objects.extraction_type                                                                                                                                     |
| p_load_type        | Тип загрузки - DELTA, DELTA_MERGE, DELTA_UPSERT, FULL, PARTITION, UPDATE_PARTITION - если не указано, то берется из настроек объекта objects.load_type                                                                                                |
| p_delta_mode       | Режим дельты - DELTA (один load_id для интервала), FULL (один load_id для интервала), ITER (несколько load_id в зависимости от указанного интервала p_load_interval) - если не указано, то берется из настроек объекта objects.delta_mode             |
| p_load_interval    | Интервал для генерации нескольких load_id - если не указано, то берется из настроек объекта objects.load_interval                                                                                                                                     |
| p_start_load       | Дата начала интервала дельты для load_id - справочный, не используется                                                                                                                                                                                |
| p_end_load         | дата окончания интервала дельты для load_id - справочный, не используется                                                                                                                                                                             |



#### f_analyze_table (text)
Функция используется для сбора статистики по указанной в параметре таблице.

*Выходной параметр*: отсутствует.

| Параметр функции   | Описание                                           |
|--------------------|----------------------------------------------------|
| p_table_name       | Имя таблицы со схемой. **Обязательный параметр**   |



#### f_create_date_partitions (text, timestamp)
Функция создает в указанной таблице p_table_name новую партицию за дату, указанную в параметре p_partition_value. Если партиция есть - новая не создается. Обязательно наличие партиции по умолчанию в целевой таблице.

*Выходной параметр*: отсутствует.

| Параметр функции   | Описание                                                                   |
|--------------------|----------------------------------------------------------------------------|
| p_table_name       | Имя таблицы со схемой. **Обязательный параметр**                           |
| p_partition_value  | Дата, для которой необходимо создать партицию. **Обязательный параметр**   |



#### f_create_ext_table (text, int8, text, text, text, text, text)
Функция создает внешнюю таблицу со структурой таблицы p_table_name, по протоколу p_load_method и строкой подключения p_connect_string.

*Выходной параметр*: имя созданной таблицы, text

| Параметр функции   | Описание                                                                                                   |
|--------------------|------------------------------------------------------------------------------------------------------------|
| p_table_name       | Имя таблицы со схемой. **Обязательный параметр**                                                           |
| p_load_id          | Идентификатор загрузки. **Обязательный параметр**                                                          |
| p_load_method      | Протокол для создания внешней таблицы. Возможные значения: pxf, gpfdist. **Обязательный параметр**         |
| p_connect_string   | Строка подключения к источнику. **Обязательный параметр**                                                  |
| p_schema_name      | Имя схемы, в которой будет создана внешняя таблица.                                                        |
| p_prefix           | Префикс создаваемой таблицы.                                                                               |
| p_suffix           | Суффикс создаваемой таблицы.                                                                               |



#### f_create_tmp_table (text, text, text, text, bool, bool)
Функция создает таблицу, которая будет использоваться в дальнейшем фреймворком как стейджинговая. В качестве шаблонной используется p_table_name.

*Выходной параметр*: имя созданной таблицы, text

| Параметр функции   | Описание                                                                                                   |
|--------------------|------------------------------------------------------------------------------------------------------------|
| p_table_name       | Имя таблицы со схемой. **Обязательный параметр**                                                           |
| p_schema_name      | Схема для создания временной таблицы. Если не указано - создается в схеме шаблонной таблицы.               |
| p_prefix_name      | Префикс создаваемой таблицы.                                                                               |
| p_suffix_name      | Суффикс создаваемой таблицы.                                                                               |
| p_drop_table       | Удалить временную таблицу перед созданием.                                                                 |
| p_is_temporary     | Создать таблицу как temporary table.                                                                       |



#### f_delete_load_lock (int8, text)
Функция удаляет блокировки, установленные фреймворком для ETL-процесса

*Выходной параметр*: флаг успешности выполнения.

| Параметр функции   | Описание                                                                   |
|--------------------|----------------------------------------------------------------------------|
| p_load_id          | id загрузки из таблицы load_info                                           |
| p_object_name      | Имя таблицы со схемой.                                                     |



#### f_gen_group_load_id (text, timestamp, timestamp, text, text, text, interval, timestamp, timestamp)
Функция создает набор load_id - идентификатор загрузки в таблице *load_info*

Выходной параметр: последний созданный load_id, int8

| Параметр функции     | Описание                                                                                                                                                                                                                                              | 
|----------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| p_load_group         | Группа загрузок из таблицы objects.load_group. **Обязательный параметр**                                                                                                                                                                              |
| p_start_extr         | Дата начала интервала загрузки для load_id - если не указано, то берется из настроек объекта objects.load_start_date                                                                                                                                  |
| p_end_extr           | Дата окончания интервала загрузки для load_id - если не указано, то берется как current_timestamp                                                                                                                                                     |
| p_extraction_type    | Тип экстракции - FULL, DELTA, PARTITION - если не указано, то берется из настроек объекта objects.extraction_type                                                                                                                                     |
| p_load_type          | Тип загрузки - DELTA, DELTA_MERGE, DELTA_UPSERT, FULL, PARTITION, UPDATE_PARTITION - если не указано, то берется из настроек объекта objects.load_type                                                                                                |
| p_delta_mode         | Режим дельты - DELTA (один load_id для интервала), FULL (один load_id для интервала), ITER (несколько load_id в зависимости от указанного интервала p_load_interval) - если не указано, то берется из настроек объекта objects.delta_mode             |
| p_load_interval      | Интервал для генерации нескольких load_id - если не указано, то берется из настроек объекта objects.load_interval                                                                                                                                     |
| p_start_load         | Дата начала интервала дельты для load_id - справочный, не используется                                                                                                                                                                                |
| p_end_load           | дата окончания интервала дельты для load_id - справочный, не используется                                                                                                                                                                             |



#### f_get_connection_string (int8)
Функция получения строки подключения к таблице внешней системы из настроек объекта.

*Выходной параметр*: строка подключения, text

| Параметр функции   | Описание                                                                   |
|--------------------|----------------------------------------------------------------------------|
| p_load_id          | id загрузки из таблицы load_info. **Обязательный параметр**                |



#### f_get_distribution_key (text)
Функция получения ключа распределения таблицы в виде DISTRIBUTED by (...), DISTRIBUTED RANDOMLY.

*Выходной параметр*: строка дистрибуции таблицы, text

| Параметр функции   | Описание                                                                   |
|--------------------|----------------------------------------------------------------------------|
| p_table_name       | Имя таблицы со схемой. **Обязательный параметр**                           |



#### f_get_enum_partition (text, text, date, date)
Функция получения строки для pxf-партиций в случае использования партиций по отдельным значениям.

*Выходной параметр*: строка pxf-партиций, text

| Параметр функции   | Описание                                                                                                   |
|--------------------|------------------------------------------------------------------------------------------------------------|
| p_field_name       | Имя поля для партиционирования. **Обязательный параметр**                                                  |
| p_format           | Формат преобразования даты в строку (напр., 'YYYYMMDD'). **Обязательный параметр**                         |
| p_start_date       | Дата начала интервала партиционирования. **Обязательный параметр**                                         |
| p_end_date         | Дата окончания интервала партиционирования. **Обязательный параметр**                                      |



#### f_get_load_id (int8, date, date)
Функция получения load_id для объекта за указанные даты. Если дат не указано - возвращается максимальный по дате.

*Выходной параметр*: удовлетворяющий условиям load_id, int8

| Параметр функции   | Описание                                                                                                   |
|--------------------|------------------------------------------------------------------------------------------------------------|
| p_object_id        | Идентификатор объекта из таблицы objects.object_id **Обязательный параметр**                               |
| p_start_date       | Дата начала периода                                                                                        |
| p_end_date         | Дата окончания периода                                                                                     |



#### f_get_load_expression (int8)
Функция получения SQL-выражения для загрузки из внешней таблицы-источника в таблицу-приемник с учетом правил трансформации.

*Выходной параметр*: SQL-выражение для загрузки, text

| Параметр функции   | Описание                                                                   |
|--------------------|----------------------------------------------------------------------------|
| p_load_id          | id загрузки из таблицы load_info. **Обязательный параметр**                |



#### f_get_locks ()
Функция получения всех блокировок, присутствующих в базе.

*Выходной параметр*: таблица pg_catalog.pg_locks

| Параметр функции   | Описание                                                                   |
|--------------------|----------------------------------------------------------------------------|
|                    |                                                                            |



#### f_get_load_locks (text)
Функция получения ETL-блокировок, присутствующих в базе для указанной таблицы.

*Выходной параметр*: таблица locks по указанной таблице.

| Параметр функции   | Описание                                                                   |
|--------------------|----------------------------------------------------------------------------|
| p_object_name      | Имя таблицы для поиска блокировок                                          |



#### f_get_merge_key (int8)
Функция получения ключа для мерджа по id объекта из *objects*

*Выходной параметр*: список полей для мерджа, _text

| Параметр функции   | Описание                                                                        |
|--------------------|---------------------------------------------------------------------------------|
| p_object_id        | id объекта загрузки из таблицы objects.object_id. **Обязательный параметр**     |



#### f_get_partition_key (text)
Функция получения имени колонки, по которой построены партиции в указанной таблице.

*Выходной параметр*: имя ключа партиционирования, text

| Параметр функции   | Описание                                                                   |
|--------------------|----------------------------------------------------------------------------|
| p_table_name       | Имя таблицы со схемой. **Обязательный параметр**                           |



#### f_get_table_attributes (text)
Функция получения атрибутов указанной таблицы - тип хранения, ориентация, сжатие.

*Выходной параметр*: строка атрибутов таблицы (with (appendonly=true,...)), text

| Параметр функции   | Описание                                                                   |
|--------------------|----------------------------------------------------------------------------|
| p_table_name       | Имя таблицы со схемой. **Обязательный параметр**                           |



#### f_get_table_schema (text)
Функция получения схемы указанной таблицы.

*Выходной параметр*: схема таблицы, text

| Параметр функции   | Описание                                                                   |
|--------------------|----------------------------------------------------------------------------|
| p_table            | Имя таблицы со схемой. **Обязательный параметр**                           |



#### f_get_where_clause (int8)
Функция получения условия where для загрузки из внешней системы в целевую таблицу для указанного object_id.

*Выходной параметр*: строка для условия where, text

| Параметр функции   | Описание                                                                        |
|--------------------|---------------------------------------------------------------------------------|
| p_object_id        | id объекта загрузки из таблицы objects.object_id. **Обязательный параметр**     |



#### f_grant_select (text, text)
Функция выдачи полномочий на таблицу p_trg_table_name аналогичных таблице p_src_table.

*Выходной параметр*: отсутствует.

| Параметр функции   | Описание                                                                                                   |
|--------------------|------------------------------------------------------------------------------------------------------------|
| p_trg_table_name   | Имя целевой таблицы со схемой. **Обязательный параметр**                                                   |
| p_src_table        | Имя таблицы-шаблона для полномочий со схемой. **Обязательный параметр**                                    |



#### f_insert_table (text, text, text, bool)
Функция загрузки данных из таблицы p_table_from в таблицу p_table_to с условием p_where.

*Выходной параметр*: количество вставленных записей, int8

| Параметр функции   | Описание                                                                                                   |
|--------------------|------------------------------------------------------------------------------------------------------------|
| p_table_from       | Имя исходной таблицы со схемой. **Обязательный параметр**                                                  |
| p_table_to         | Имя целевой таблицы со схемой. **Обязательный параметр**                                                   |
| p_where            | Условие вставки в целевую таблицу.                                                                         |
| p_truncate_tgt     | Флаг очистки целевой таблицы перед вставкой данных.                                                        |



#### f_load_id_exists (int8, timestamp, timestamp)
Функция проверки существования load_id по указанному временному периоду.

*Выходной параметр*: флаг наличия соответствующего load_id, bool

| Параметр функции   | Описание                                                                                                   |
|--------------------|------------------------------------------------------------------------------------------------------------|
| p_object_id        | Идентификатор объекта из таблицы objects.object_id **Обязательный параметр**                               |
| p_start_date       | Дата начала периода. **Обязательный параметр**                                                             |
| p_end_date         | Дата окончания периода. **Обязательный параметр**                                                          |



#### f_load_delta_merge (int8)
Функция загрузки данных путем мерджа таблиц с последующей заменой партиции по умолчанию.

*Выходной параметр*: количество загруженных записей, int8

| Параметр функции   | Описание                                                                                                   |
|--------------------|------------------------------------------------------------------------------------------------------------|
| p_load_id          | Идентификатор загрузки из таблицы load_info.load_id **Обязательный параметр**                              |



#### f_merge_tables (text, text, text, _text, text)
Функция мерджа таблицы p_table_from_name с таблицей p_table_to_name с заменой дефолтной партиции у целевой таблицы с указанным ключом мерджа и возможностью указания целевой таблицы. В процессе создается буферная или указанная целевая таблица.

*Выходной параметр*: количество обновленных записей в целевой таблице, int8

| Параметр функции     | Описание                                                                                                 | 
|----------------------|----------------------------------------------------------------------------------------------------------|
| p_table_from_name    | Имя исходной таблицы со схемой с новыми данными. **Обязательный параметр**                               |
| p_table_to_name      | Имя таблицы со схемой, содержащей целевые данные для мерджа. **Обязательный параметр**                   |
| p_where              | Условие where, применяемое к данным исходной таблицы. **Обязательный параметр**                          |
| p_merge_key          | Поле для мерджа таблиц. **Обязательный параметр**                                                        |
| p_trg_table          | Имя новой создаваемой таблицы с результатом мерджа.                                                      |



#### f_partition_name_by_value (text, timestamp)
Функция получения имени партиции по значению даты, входящей в эту партицию.

*Выходной параметр*: имя партиции, text

| Параметр функции   | Описание                                                                                                   |
|--------------------|------------------------------------------------------------------------------------------------------------|
| p_table_name       | Имя таблицы со схемой. **Обязательный параметр**                                                           |
| p_partition_value  | Значение даты для поиска. **Обязательный параметр**                                                        |



#### f_partition_name_list_by_date (text, timestamp, timestamp)
Функция получения имени партиции по значению интервала дат, входящего в эту партицию.

*Выходной параметр*: имя партиции, text

| Параметр функции   | Описание                                                                                                   |
|--------------------|------------------------------------------------------------------------------------------------------------|
| p_table_name       | Имя таблицы со схемой. **Обязательный параметр**                                                           |
| p_partition_start  | Начало интервала. **Обязательный параметр**                                                                |
| p_partition_end    | Конец интервала. **Обязательный параметр**                                                                 |



#### f_prepare_load (int8)
Функция создания временных объектов для загрузки данных в целевую таблицу (delta_, ext_).

*Выходной параметр*: флаг успешности завершения подготовки, bool

| Параметр функции   | Описание                                                                                                   |
|--------------------|------------------------------------------------------------------------------------------------------------|
| p_load_id          | id загрузки из таблицы load_info **Обязательный параметр**                                                 |



##### f_set_load_id_error (int8)
Функция установки статуса "Ошибка" для load_id.

*Выходной параметр*: отсутствует

| Параметр функции   | Описание                                                                                                   |
|--------------------|------------------------------------------------------------------------------------------------------------|
| p_load_id          | id загрузки из таблицы load_info **Обязательный параметр**                                                 |



#### f_set_load_id_in_process (int8)
Функция установки статуса "В работе" для load_id.

*Выходной параметр*: отсутствует

| Параметр функции   | Описание                                                                                                   |
|--------------------|------------------------------------------------------------------------------------------------------------|
| p_load_id          | id загрузки из таблицы load_info **Обязательный параметр**                                                 |



#### f_set_load_id_success (int8)
Функция установки статуса "Успешно" для load_id.

*Выходной параметр*: отсутствует.

| Параметр функции   | Описание                                                                                                   |
|--------------------|------------------------------------------------------------------------------------------------------------|
| p_load_id          | id загрузки из таблицы load_info **Обязательный параметр**                                                 |



#### f_set_load_lock (int8, text, text)
Функция установки ETL-блокировки на таблицу для указанного load_id.

*Выходной параметр*: флаг успешной установки, bool

| Параметр функции   | Описание                                                                                                   |
|--------------------|------------------------------------------------------------------------------------------------------------|
| p_load_id          | id загрузки из таблицы load_info **Обязательный параметр**                                                 |
| p_lock_type        | Тип блокировки. **Обязательный параметр**                                                                  |
| p_object_name      | Имя таблицы. **Обязательный параметр**                                                                     |



#### f_stat_activity ()
Функция отображения текущих процессов в БД.

*Выходной параметр*: таблица pg_catalog.pg_stat_activity

| Параметр функции   | Описание                                                                   |
|--------------------|----------------------------------------------------------------------------|
|                    |                                                                            |



#### f_switch_def_partition (text, text)
Функция смены партиции по умолчанию у таблицы p_table_to_name таблицей p_table_from_name

*Выходной параметр*: отсутствует.

| Параметр функции   | Описание                                                                                                   |
|--------------------|------------------------------------------------------------------------------------------------------------|
| p_table_from_name  | Имя исходной таблицы со схемой. **Обязательный параметр**                                                  |
| p_table_to_name    | Имя целевой таблицы со схемой. **Обязательный параметр**                                                   |



#### f_switch_partition (text, text, text)
Функция смены партиции p_partition_name указанной таблицы p_table_name таблицей p_switch_table_name

*Выходной параметр*: отсутствует.

| Параметр функции      | Описание                                                                                                   |
|-----------------------|------------------------------------------------------------------------------------------------------------|
| p_table_name          | Имя целевой таблицы со схемой. **Обязательный параметр**                                                   |
| p_partition_name      | Имя партиции в целевой таблице. **Обязательный параметр**                                                  |
| p_switch_table_name   | Имя исходной таблицы со схемой. **Обязательный параметр**                                                  |



#### f_switch_partition (text, timestamp, text)
Функция смены партиции для значения даты p_partition_value указанной таблицы p_table_name таблицей p_switch_table_name

*Выходной параметр*: отсутствует.

| Параметр функции      | Описание                                                                                                   |
|-----------------------|------------------------------------------------------------------------------------------------------------|
| p_table_name          | Имя целевой таблицы со схемой. **Обязательный параметр**                                                   |
| p_partition_value     | Значение даты в партиции в целевой таблице. **Обязательный параметр**                                      |
| p_switch_table_name   | Имя исходной таблицы со схемой. **Обязательный параметр**                                                  |



#### f_unify_name (text)
Функция приведения имени входного параметра в унифицированный формат.

*Выходной параметр*: параметр в унифицированном формате, text

| Параметр функции   | Описание                                                                                                   |
|--------------------|------------------------------------------------------------------------------------------------------------|
| p_name             | Имя параметра для унификации. **Обязательный параметр**                                                    |



#### f_upsert_table (int8, text, text, bool, bool, text)
Функция загрузки таблицы методом UPSERT (delete по ключу мерджа, insert новых данных).

*Выходной параметр*: количество обновленных записей в целевой таблице, int8

| Параметр функции      | Описание                                                                                                   |
|-----------------------|------------------------------------------------------------------------------------------------------------|
| p_load_id             | id загрузки из таблицы load_info **Обязательный параметр**                                                 |
| p_table_from_name     | Имя исходной таблицы со схемой. **Обязательный параметр**                                                  |
| p_table_to_name       | Имя целевой таблицы со схемой. **Обязательный параметр**                                                   |
| p_delete_duplicates   | Удалять дубликаты по merge_key.                                                                            |
| p_analyze             | Флаг сбора статистики таблицы.                                                                             |
| p_where               | Условие загрузки данных.                                                                                   |



#### f_wait_locks (text, int4, int4, bool)
Функция таймера ожидания сброса блокировки таблицы.

*Выходной параметр*: отсутствует.

| Параметр функции      | Описание                                                                                                   |
|-----------------------|------------------------------------------------------------------------------------------------------------|
| p_table_name          | Имя исходной таблицы со схемой. **Обязательный параметр**                                                  |
| p_repeat_interval     | Интервал ожидания в секундах. **Обязательный параметр**                                                    |
| p_repeat_count        | Количество итераций проверки. **Обязательный параметр**                                                    |
| p_terminate_lock      | Флаг удаления ETL-блокировки на таблице.                                                                   |



#### f_write_log (text, text, text, int8)
Функция записи лога выполнения операции.

*Выходной параметр*: отсутствует.

| Параметр функции   | Описание                                                                                                   |
|--------------------|------------------------------------------------------------------------------------------------------------|
| p_log_type         | Тип лога ('ERROR','INFO','DEBUG','WARN'). **Обязательный параметр**                                        |
| p_log_message      | Сообщение для записи в лог. **Обязательный параметр**                                                      |
| p_location         | Функция, где возникло сообщение. **Обязательный параметр**                                                 |
| p_load_id          | id загрузки.                                                                                               |



#### f_truncate_table (text)
Функция очистки указанной таблицы через truncate.

*Выходной параметр*: отсутствует.

| Параметр функции   | Описание                                                                                                   |
|--------------------|------------------------------------------------------------------------------------------------------------|
| p_table_name       | Имя очищаемой таблицы со схемой. **Обязательный параметр**                                                 |



#### f_load_delta_partitions (int8, text, text, bool, text)
Функция итерационной загрузки данных из таблицы p_table_from_name в партиции целевой таблицы p_table_to_name, в качестве интервала используется интервал из p_load_id.

*Выходной параметр*: количество вставленных записей в целевой таблице, int8

| Параметр функции      | Описание                                                                                                                             |
|-----------------------|--------------------------------------------------------------------------------------------------------------------------------------|
| p_load_id             | id загрузки. **Обязательный параметр**                                                                                               |
| p_table_from_name     | Имя исходной таблицы со схемой. **Обязательный параметр**                                                                            |
| p_table_to_name       | Имя целевой таблицы со схемой. **Обязательный параметр**                                                                             |
| p_merge_partitions    | Флаг мерджа изменений (true - обновление записей в партиции, false - полная замена данных в партиции). **Обязательный параметр**     |
| p_where               | Условие загрузки.                                                                                                                    |



#### f_table_exists (text)
Функция проверки существования таблицы в базе.

*Выходной параметр*: флаг наличия таблицы в базе, bool

| Параметр функции   | Описание                                                                                                   |
|--------------------|------------------------------------------------------------------------------------------------------------|
| p_table_name       | Имя таблицы со схемой. **Обязательный параметр**                                                           |



#### f_execute_function (text, int8)
Функция запуска указанной функции. Возможно указание переменных из параметров p_load_id ($load_from, $load_to, $extraction_from, $extraction_to, $load_id, $load_type, $extraction_type, $object_id).

*Выходной параметр*: флаг успешного завершения функции, bool

| Параметр функции      | Описание                                                                                                   |
|-----------------------|------------------------------------------------------------------------------------------------------------|
| p_function_name       | Имя функции со схемой и параметрами. **Обязательный параметр**                                             |
| p_load_id             | id загрузки.                                                                                               |



#### f_get_max_value (text, text, text)
Функция получения максимального значения столбца из таблицы. Необходимо для корректировки даты для load_id.

*Выходной параметр*: максимальное значение в указанном столбце, text

| Параметр функции   | Описание                                                                                                   |
|--------------------|------------------------------------------------------------------------------------------------------------|
| p_table_name       | Имя таблицы со схемой. **Обязательный параметр**                                                           |
| p_field_name       | Имя поля в таблице. **Обязательный параметр**                                                              |
| p_where            | Условие для ограничения.                                                                                   |



#### f_get_min_value (text, text, text)
Функция получения минимального значения столбца из таблицы. Необходимо для корректировки даты для load_id.

*Выходной параметр*: минимальное значение в указанном столбце, text

| Параметр функции   | Описание                                                                                                   |
|--------------------|------------------------------------------------------------------------------------------------------------|
| p_table_name       | Имя таблицы со схемой. **Обязательный параметр**                                                           |
| p_field_name       | Имя поля в таблице. **Обязательный параметр**                                                              |
| p_where            | Условие для ограничения.                                                                                   |



#### f_update_load_info (int8, text, text)
Функция обновления указанного поля в таблице load_info

*Выходной параметр*: отсутствует.

| Параметр функции   | Описание                                                                                                   |
|--------------------|------------------------------------------------------------------------------------------------------------|
| p_load_id          | id загрузки. **Обязательный параметр**                                                                     |
| p_field_name       | Имя поля в таблице load_id **Обязательный параметр**                                                       |
| p_value            | Устанавливаемое значение **Обязательный параметр**                                                         |



#### f_get_load_function (int8)
Функция получения функции загрузки объекта из таблицы objects

*Выходной параметр*: строка вызова функции, text

| Параметр функции   | Описание                                                                                                   |
|--------------------|------------------------------------------------------------------------------------------------------------|
| p_object_id        | id объекта. **Обязательный параметр**                                                                      |



#### f_insert_table_sql (text, text, bool)
Функция загрузки данных из SQL запроса p_sql в таблицу p_table_to

*Выходной параметр*: количество вставленных записей, int8

| Параметр функции   | Описание                                                                                                   |
|--------------------|------------------------------------------------------------------------------------------------------------|
| p_table_to         | Имя целевой таблицы со схемой. **Обязательный параметр**                                                   |
| p_sql              | SQL запрос для вставки данных. **Обязательный параметр**                                                   |
| p_truncate_tgt     | Очищать ли целевую таблицу перед вставкой.                                                                 |



#### f_upsert_table_sql (text, text, int8, bool, bool)
Функция загрузки таблицы методом UPSERT (delete по ключу мерджа, insert новых данных) на основании SQL запроса.

*Выходной параметр*: количество вставленных записей, int8

| Параметр функции      | Описание                                                                                                |
|-----------------------|---------------------------------------------------------------------------------------------------------|
| p_table_to_name       | Имя целевой таблицы со схемой. **Обязательный параметр**                                                |
| p_sql                 | SQL запрос для обновленных данных. **Обязательный параметр**                                            |
| p_load_id             | id загрузки. **Обязательный параметр**                                                                  |
| p_delete_duplicates   | Удалять дубликаты по merge_key.                                                                         |
| p_analyze             | Флаг исполнения analyze table после обновления данных.                                                  |



#### f_set_session_param (text, text)
Функция установки значения для пользовательского параметра сессии.

*Выходной параметр*: флаг успешности установки параметра, bool

| Параметр функции   | Описание                                                                                                   |
|--------------------|------------------------------------------------------------------------------------------------------------|
| p_param_name       | Имя параметра. **Обязательный параметр**                                                                   |
| p_param_value      | Значение параметра. **Обязательный параметр**                                                              |



#### f_get_session_param (text)
Функция получения значения для пользовательского параметра сессии.

*Выходной параметр*: значение параметра, text

| Параметр функции   | Описание                                                                                                   |
|--------------------|------------------------------------------------------------------------------------------------------------|
| p_param_name       | Имя параметра. **Обязательный параметр**                                                                   |



#### f_load_object (int8)
Функция запуска загрузки объекта с помощью функции objects.load_function

*Выходной параметр*: флаг успешной загрузки данных, bool

| Параметр функции   | Описание                                                                                                   |
|--------------------|------------------------------------------------------------------------------------------------------------|
| p_load_id          | id загрузки. **Обязательный параметр**                                                                     |



#### f_load_simple_full (int8, text, text)
Функция загрузки целевого объекта с помощью полной перегрузки из таблицы-источника с созданием бэкап-таблицы.

*Выходной параметр*: флаг успешной загрузки данных, bool

| Параметр функции   | Описание                                                                                                   |
|--------------------|------------------------------------------------------------------------------------------------------------|
| p_load_id          | id загрузки. **Обязательный параметр**                                                                     |
| p_src_table        | Источник данных - таблица или view. **Обязательный параметр**                                              |
| p_trg_table        | Целевая таблица.                                                                                           |



#### f_load_simple_upsert (int8, text, text, bool, text)
Функция загрузки целевого объекта с помощью update-insert из таблицы-источника по merge-ключу.

*Выходной параметр*: флаг успешной загрузки данных, bool

| Параметр функции      | Описание                                                                                                |
|-----------------------|---------------------------------------------------------------------------------------------------------|
| p_load_id             | id загрузки. **Обязательный параметр**                                                                  |
| p_src_table           | Таблица или view - источник данных. **Обязательный параметр**                                           |
| p_trg_table           | Целевая таблица.                                                                                        |
| p_delete_duplicates   | Флаг удаления дубликатов по ключу мерджа.                                                               |
| p_where               | Условие загрузки данных.                                                                                |



#### f_load_simple (int8, text, text, bool)
Функция загрузки целевого объекта без преобразования полей с помощью указанного метода из таблицы-источника.

*Выходной параметр*: флаг успешной загрузки данных, bool

| Параметр функции      | Описание                                                                                                      |
|-----------------------|---------------------------------------------------------------------------------------------------------------|
| p_load_id             | id загрузки. **Обязательный параметр**                                                                        |
| p_src_table           | Таблица или view - источник данных. **Обязательный параметр**                                                 |
| p_trg_table           | Целевая таблица.                                                                                              |
| p_delete_duplicates   | Флаг удаления дубликатов по ключу мерджа. Актуален для методов загрузки DELTA_UPSERT, DELTA, DELTA_MERGE.     |



#### f_update_table_sql (text, text, _text, int8)
Функция обновления полей в указанной таблице по набору полей из SQL запроса.

*Выходной параметр*: количество обновленных записей, int8

| Параметр функции      | Описание                                                                                                               |
|-----------------------|------------------------------------------------------------------------------------------------------------------------|
| p_table_to_name       | Целевая таблица. **Обязательный параметр**                                                                             |
| p_sql                 | SQL запрос, формирующий набор данных, на основании которого будет происходить обновление **Обязательный параметр**     |
| p_column_list         | Набор колонок для обновления. **Обязательный параметр**                                                                |
| p_load_id             | id загрузки, для определения ключа мерджа. **Обязательный параметр**                                                   |



#### f_update_table_sql (text, text, _text, _text)
Функция обновления полей в указанной таблице по набору полей из SQL запроса.

*Выходной параметр*: количество обновленных записей, int8

| Параметр функции      | Описание                                                                                                               |
|-----------------------|------------------------------------------------------------------------------------------------------------------------|
| p_table_to_name       | Целевая таблица. **Обязательный параметр**                                                                             |
| p_sql                 | SQL запрос, формирующий набор данных, на основании которого будет происходить обновление. **Обязательный параметр**    |
| p_column_list         | Набор колонок для обновления. **Обязательный параметр**                                                                |
| p_merge_key           | Список полей для мерджа. **Обязательный параметр**                                                                     |



#### f_get_constant (text)
Функция получения константы из таблицы load_constants

*Выходной параметр*: значение константы, text

| Параметр функции      | Описание                                                                                                               |
|-----------------------|------------------------------------------------------------------------------------------------------------------------|
| p_constant_name       | Имя константы. **Обязательный параметр**                                                                               |



#### f_get_where_cond (int8, text)
Функция получения полного условия для загрузки из исходной системы для load_id

*Выходной параметр*: значение условия where, text

| Параметр функции      | Описание                                                                                                               |
|-----------------------|------------------------------------------------------------------------------------------------------------------------|
| p_load_id             | id загрузки. **Обязательный параметр**                                                                                 |
| p_table_alias         | Псевдоним целевой таблицы в условии where.                                                                             |



#### f_get_delta_table_name (int8)
Функция получения имени дельта-таблицы для указанного id загрузки.

*Выходной параметр*: имя таблицы, text

| Параметр функции      | Описание                                                                                                               |
|-----------------------|------------------------------------------------------------------------------------------------------------------------|
| p_load_id             | id загрузки. **Обязательный параметр**                                                                                 |



#### f_get_ext_table_name (int8)
Функция получения имени внешней таблицы для указанного id загрузки.

*Выходной параметр*: имя таблицы, text

| Параметр функции      | Описание                                                                                                               |
|-----------------------|------------------------------------------------------------------------------------------------------------------------|
| p_load_id             | id загрузки. **Обязательный параметр**                                                                                 |



#### f_get_extr_expression (int8, text, text)
Функция получения SQL-выражения для экстракции данных из таблицы-источника в таблицу-приемник с учетом правил трансформации.

*Выходной параметр*: SQL-выражение для вставки, text

| Параметр функции      | Описание                                                                                                               |
|-----------------------|------------------------------------------------------------------------------------------------------------------------|
| p_load_id             | id загрузки. **Обязательный параметр**                                                                                 |
| p_source_table        | Имя таблицы-источника со схемой. **Обязательный параметр**                                                             |
| p_trg_table           | Имя таблицы-приемника со схемой.                                                                                       |



#### f_get_extract_where_cond (int8, text)
Функция получения условия where для экстракции данных из таблицы-источника в таблицу-приемник с учетом правил трансформации.

*Выходной параметр*: where-условие для экстракции, text

| Параметр функции      | Описание                                                                                                               |
|-----------------------|------------------------------------------------------------------------------------------------------------------------|
| p_load_id             | id загрузки. **Обязательный параметр**                                                                                 |
| p_table_alias         | Псевдоним таблицы-источника.                                                                                           |



#### f_extract_data (int8)
Функция загрузки данных из внешней таблицы в стейджинговую таблицу БД для указанного id загрузки.

*Выходной параметр*: флаг успешного завершения загрузки, bool

| Параметр функции      | Описание                                                                                                               |
|-----------------------|------------------------------------------------------------------------------------------------------------------------|
| p_load_id             | id загрузки. **Обязательный параметр**                                                                                 |



#### f_load_data (int8)
Функция загрузки данных из стейджинговой таблицы в целевую таблицу БД для указанного id загрузки.

*Выходной параметр*: флаг успешного завершения загрузки, bool

| Параметр функции      | Описание                                                                                                               |
|-----------------------|------------------------------------------------------------------------------------------------------------------------|
| p_load_id             | id загрузки. **Обязательный параметр**                                                                                 |



#### f_delete_table_sql (text, text, _text)
Функция удаления данных в целевой таблице из набора данных, полученных из запроса p_sql по ключу, указанному в параметре p_merge_key.

*Выходной параметр*: количество удаленных записей в целевой таблице, в случае ошибки выполнения - null, int8

| Параметр функции      | Описание                                                                                                               |
|-----------------------|------------------------------------------------------------------------------------------------------------------------|
| p_table_name          | Имя целевой таблицы со схемой. **Обязательный параметр**                                                               |
| p_sql                 | SQL запрос, определяющий набор данных для удаления из целевой таблицы. **Обязательный параметр**                       |
| p_merge_key           | Список полей, по которым идет удаление из целевой таблицы. **Обязательный параметр**                                   |



#### f_get_pxf_partition (int8)
Функция формирования строки партиционирования для строки подключения pxf на основании интервала загрузки данных.

*Выходной параметр*: строка партиционирования, text

| Параметр функции      | Описание                                                                                                               |
|-----------------------|------------------------------------------------------------------------------------------------------------------------|
| p_load_id             | id загрузки. **Обязательный параметр**                                                                                 |



#### f_create_obj_sql (text, text, text, text, bool, text, bool, bool, text)
Функция создания таблицы, временной таблицы или view на основании SQL запроса.

*Выходной параметр*: количество загруженных записей, int8

| Параметр функции      | Описание                                                                                                                          |
|-----------------------|-----------------------------------------------------------------------------------------------------------------------------------|
| p_schema_name         | Схема создаваемого объекта. **Обязательный параметр**                                                                             |
| p_obj_name            | Имя объекта. **Обязательный параметр**                                                                                            |
| p_sql_text            | SQL для создания объекта. **Обязательный параметр**                                                                               |
| p_grants_template     | Таблица-шаблон для выдачи полномочий на создаваемый объект.                                                                       |
| p_mat_flg             | Флаг материализации. Если false - создается view.                                                                                 |
| p_storage_opt         | Параметры хранения таблицы (если не указано, то WITH (appendonly=true,orientation=column,compresstype=zstd,compresslevel=1)).     |
| p_analyze_flg         | Собирать ли статистику у таблицы.                                                                                                 |
| p_temporary           | Создавать ли временную таблицу.                                                                                                   |
| p_distr_cls           | Ключ распределения таблицы.                                                                                                       |



#### f_load_delta_update_partitions (int8, text, text, text)
Функция обновления данных в целевой таблице из таблицы-источника методом DELTA_UPDATE_PARTITION. Из исходной таблицы итерационно обновляются данные в соответствующих партициях целевой таблицы.

*Выходной параметр*: количество загруженных записей, int8

| Параметр функции      | Описание                                                                                                               |
|-----------------------|------------------------------------------------------------------------------------------------------------------------|
| p_table_from_name     | Имя таблицы-источника данных. **Обязательный параметр**                                                                |
| p_table_to_name       | Имя целевой таблицы. **Обязательный параметр**                                                                         |
| p_load_id             | id загрузки. **Обязательный параметр**                                                                                 |
| p_where               | Условие для партиции.                                                                                                  |



#### f_get_partition_interval (text, timestamp)
Функция получения интервала партиции для таблицы по указанной дате.

*Выходной параметр*: интервал партиции, interval

| Параметр функции      | Описание                                                                                                               |
|-----------------------|------------------------------------------------------------------------------------------------------------------------|
| p_table_name          | Имя таблицы, в которой ищется партиция. **Обязательный параметр**                                                      |
| p_partition_value     | Дата для поиска. Если дата не указана, берется интервал для максимальной уже созданной партиции.                       |



#### f_terminate_backend (int4)
Функция завершение процесса в АХД по его pid. Выполняется с полномочиями администратора.

*Выходной параметр*: флаг успешности остановки процесса, bool

| Параметр функции      | Описание                                                                                                               |
|-----------------------|------------------------------------------------------------------------------------------------------------------------|
| p_pid                 | pid процесса из pg_stat_activity **Обязательный параметр**                                                             |



#### f_terminate_lock (text)
Функция удаления ETL-блокировки для таблицы.

*Выходной параметр*: флаг успешности удаления блокировки, bool

| Параметр функции      | Описание                                                                                                               |
|-----------------------|------------------------------------------------------------------------------------------------------------------------|
| p_table_name          | Имя таблицы. **Обязательный параметр**                                                                                 |




