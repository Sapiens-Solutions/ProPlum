# Примеры реализации типовых загрузок в АХД

Сценарии реализации загрузок из внешней системы в АХД с помощью ETL-фреймворка.

## Полная перегрузка данных
Вариант полной перегрузки данных подходит для перегрузки небольших справочников, а также таблиц, в которых не поддерживается отслеживание дельты.

Порядок действий:
<ol> <!--- начало нумерованного листа --> 
    <li> Создание целевой таблицы в схеме целевой системы: <!--- 1 элемент нумерованного листа --></li> 
    <li>Проверка наличия стейджинговой схемы для схемы целевой системы. <!--- 2 элемент нумерованного листа --></li>
    <li>Ввод настроек в таблицу objects. Обязательные параметры: <!--- 3 элемент нумерованного листа --> 
        <ul> <!--- ненумерованный лист --> 
            <li>object_name - имя целевой таблицы;</li>
			<li>extraction_type - тип экстракции из исходной системы - устанавливается в FULL;</li>
            <li>load_type - тип загрузки в целевую таблицу - устанавливается в FULL;</li>
            <li>load_method - pxf - для загрузки по протоколу pxf из внешней системы;</li>
            <li>load_interval - гранулярность для генерации load_id. Если указан load_interval = 1 day, то стартовая дата для load_id будет округляться до начала дня окончания последней успешной загрузки (load_info.extraction_to);</li>
            <li>active - флаг активности загрузки - индикатор попадания в общее задание по загрузке данных;</li>
            <li>delta_mode - шаблон генерации дельта-load_id, для полных загрузок устанавливается как FULL;</li>
            <li>connect_string - строка подключения к источнику, содержащая имя таблицы в исходной системе и имя профиля pxf. Опционально для полных загрузок можно указывать партиции pxf (<a href="https://docs.arenadata.io/adb/PXFJDBC/Partitioning.html">партиционирование</a>);<!--- ссылка --></li>
            <li>where_clause - можно заполнить, если необходимо ограничить данные, выбираемые из исходной системы фильтрами, не предусмотренными фреймворком. При указании фильтра в данном поле фильтры, накладываемые фреймворком, игнорируются.</li>
            <li>load_group - группа загрузок в Airflow, отвечает за то, в каком блоке будет производиться загрузка данных указанной таблицы.</li> 
        </ul>
    </li>
    <li> <!--- 4 элемент нумерованного листа --> 
        Проверка основного задания в Airflow по загрузке данных на наличие нового блока со вновь созданной записью.
        <!--- ссылка на изображение --> 
        Если необходимо загрузить данные вне регламентной загрузки, можно воспользоваться опцией указания объекта для разовой загрузки. Для этого в переменных Airflow необходимо указать в переменной single_object_id необходимый object_id.
        <!--- ссылка на изображение --> 
        После обновления переменной обновится даг single_object_dag, который будет состоять только из блоков, необходимых для загрузки указанного объекта.
        <!--- ссылка на изображение --> 
    </li>
    <li> <!--- 5 элемент нумерованного листа --> 
        Запуск и проверка загрузки.
    </li>
</ol> <!--- конец нумерованного листа --> 

## Загрузка интервала бизнес дат

Вариант с полной загрузкой интервала по бизнес-дате (считается, что дата у записи не может изменяться) подходит для загрузки партиционированных таблиц фактов.
Порядок действий:
<ol> <!--- начало нумерованного листа --> 
    <li> <!--- 1 элемент нумерованного листа -->  
        Создание целевой таблицы в схеме целевой системы.
    <b>Важно: в таблице должна быть добавлена партиция по умолчанию, т.к. если интервал загрузки превысит интервал заранее созданных партиций, новые партиции будут отрезаться от партиции по умолчанию.</b> <!--- <b> - bold --> 
    </li>
    <li> <!--- 2 элемент нумерованного листа -->
        Проверка наличия стейджинговой схемы для схемы целевой системы.
    </li>
    <li> <!--- 3 элемент нумерованного листа -->
        Ввод настроек в таблицу objects. Обязательные параметры:
        <ul> <!--- ненумерованный лист -->
            <li>object_name - имя целевой таблицы;</li>
            <li>extraction_type - тип экстракции из исходной системы - устанавливается в PARTITION;</li>
			<li>load_type - тип загрузки в целевую таблицу - устанавливается в PARTITION;</li>
            <li>bdate_field - поле бизнес даты, по которому построены партиции в целевой таблице;
</li>
            <li>bdate_field_format - формат поля бизнес даты, по умолчанию считается как 'YYYY-MM-DD';
</li>
            <li>load_method - pxf - для загрузки по протоколу pxf из внешней системы;
</li>
            <li>load_interval - гранулярность для генерации load_id, а также интервал партиций в целевой таблице. Важно, чтобы параметр был указан корректно, иначе это приведет к загрузке неполных данных в целевую таблицу;
</li>
            <li>active - флаг активности загрузки - индикатор попадания в общее задание по загрузке данных;
</li>
            <li>load_start_date - дата начала истории по бизнес дате - необходимо для определения левой границы интервала загрузки при первоначальной загрузке данных;
</li>
            <li>delta_mode - шаблон генерации load_id, для дельта загрузок устанавливается как DELTA. Разрешается также указывать ITER, при этом будет генерироваться несколько load_id с интервалами, равными load_interval. <b>Важно: т.к. регулярное задание за один раз обрабатывает только один load_id, то в основном шаблон ITER необходим для разовой загрузки объекта отдельным заданием, запланированным на итерационное выполнение.</b>

</li>
            <li>connect_string - строка подключения к источнику, содержащая имя таблицы в исходной системе и имя профиля pxf. <b>Важно: для широких интервалов (больше одного дня), партиции pxf строятся автоматически и отображаются в DDL внешней таблицы. Указывать pxf-партиций для дельта-загрузок вручную не нужно!</b>

</li>
            <li>where_clause - можно заполнить, если необходимо ограничить данные, выбираемые из исходной системы фильтрами, не предусмотренными фреймворком. <b>Важно: при указании фильтра в данном поле фильтры, накладываемые фреймворком, игнорируются;</b> <!--- ссылка -->
</li>
            <li>load_group - группа загрузок в Airflow, отвечает за то, в каком блоке будет производиться загрузка данных указанной таблицы.
            <!--- ссылка на изображение --></li>
        </ul>
    </li>
    <li> <!--- 4 элемент нумерованного листа -->
       Проверка основного задания в Airflow по загрузке данных на наличие нового блока со вновь созданной записью.
        <!--- ссылка на изображение -->
        Если необходимо загрузить данные вне регламентной загрузки, можно воспользоваться опцией указания объекта для разовой загрузки. Для этого в переменных Airflow необходимо указать в переменной single_object_id необходимый object_id.
         <!--- ссылка на изображение -->
        После обновления переменной обновится даг single_object_dag, который будет состоять только из блоков, необходимых для загрузки указанного объекта.
         <!--- ссылка на изображение -->
    </li>
    <li> <!--- 5 элемент нумерованного листа -->
        Запуск и проверка загрузки.
    </li>
</ol> <!--- конец нумерованного листа -->

## Загрузка дельты данных

Вариант с загрузкой изменений данных по полю с датой изменения записи подходит для загрузки таблиц фактов, справочников.

Порядок действий:
<ol> <!--- начало нумерованного листа -->
    <li>  <!--- 1 элемент нумерованного листа -->
        Создание целевой таблицы в схеме целевой системы.       
    <b>Примечание: наличие партиций в таблице по используемому типу загрузки:</b> <!--- <b> bold --> 
    <ul> <!--- ненумерованный лист --> 
        <b><li>DELTA_UPSERT - могут быть партиции, может быть партиция по умолчанию, может не быть партиций;</li>
        <li>DELTA - могут быть партиции, может быть партиция по умолчанию, может не быть партиций;</li>
        <li>DELTA_MERGE - должна быть только партиция по умолчанию;</li>
        <li>UPDATE_PARTITION - должна быть партиция по умолчанию и партиции по полю бизнес-даты.</li></b>
    </ul>
    </li>
    <li>Проверка наличия стейджинговой схемы для схемы целевой системы.</li> <!--- 2 элемент нумерованного листа -->
    <li>Ввод настроек в таблицу objects. Обязательные параметры: <!--- 3 элемент нумерованного листа -->
        <ul> <!--- ненумерованный лист -->
            <li>object_name - имя целевой таблицы;</li>
			<li>extraction_type - тип экстракции из исходной системы - DELTA;</li>
            <li>load_type - тип загрузки в целевую таблицу - DELTA_UPSERT (обновление данных по ключу merge_key способом DELETE-INSERT), DELTA - простая вставка данных, DELTA_MERGE (обновление данных по ключу merge_key с помощью пересчета и замены партиции по умолчанию), UPDATE_PARTITION (обновление данных в соответствующих партициях целевой таблицы);</li>
            <li>delta_field - поле дельты, по которому будут отслеживаться изменения записей;</li>
            <li>delta_field_format - формат поля дельты, по умолчание считается как 'YYYY-MM-DD';</li>
            <li>bdate_field - поле бизнес-даты, по которому будут определены партиции в целевой таблице (для UPDATE_PARTITION);</li>
            <li>bdate_field_format - формат поля бизнес-даты, по умолчание считается как 'YYYY-MM-DD';</li>
            <li>load_method - pxf - для загрузки по протоколу pxf из внешней системы;</li>
            <li>load_interval - гранулярность времени для генерации load_id, отвечает также за округление даты начала загрузки;</li>
            <li>active - флаг активности загрузки - индикатор попадания в общее задание по загрузке данных;</li>
            <li>delta_start_date - дата начала истории по дельте - необходимо для определения левой границы интервала загрузки при первоначальной загрузке данных;</li>
            <li>delta_mode - шаблон генерации load_id, для дельта загрузок устанавливается как DELTA. Разрешается также указывать ITER, при этом будет генерироваться несколько load_id с интервалами, равными load_interval. <b>Важно: т.к. регулярное задание за один раз обрабатывает только один load_id, то в основном шаблон ITER необходим для разовой загрузки объекта отдельным заданием, запланированным на итерационное выполнение;</b></li>
            <li>connect_string - строка подключения к источнику, содержащая имя таблицы в исходной системе и имя профиля pxf. <b>Важно: для широких интервалов (больше одного дня), партиции pxf строятся автоматически и отображаются в DDL внешней таблицы. Указывать pxf-партиций для дельта-загрузок вручную не нужно!</b></li>
            <li>where_clause - можно заполнить, если необходимо ограничить данные, выбираемые из исходной системы фильтрами, не предусмотренными фреймворком. Важно: при указании фильтра в данном поле фильтры, накладываемые фреймворком, игнорируются;</li>
            <li>load_group - группа загрузок в Airflow, отвечает за то, в каком блоке будет производиться загрузка данных указанной таблицы.
            <!--- ссылка на изображение --></li>
        </ul>
    </li>
    <li> <!--- 4 элемент нумерованного листа -->
        Проверка основного задания в Airflow по загрузке данных на наличие нового блока со вновь созданной записью.
        <!--- ссылка на изображение -->
        Если необходимо загрузить данные вне регламентной загрузки, можно воспользоваться опцией указания объекта для разовой загрузки. Для этого в переменных Airflow необходимо указать в переменной single_object_id необходимый object_id.
        <!--- ссылка на изображение -->
        После обновления переменной обновится даг single_object_dag, который будет состоять только из блоков, необходимых для загрузки указанного объекта.
        <!--- ссылка на изображение -->
    </li>
    <li><!--- 5 элемент нумерованного листа -->
        Запуск и проверка загрузки.
    </li>
</ol> <!--- конец нумерованного листа -->
